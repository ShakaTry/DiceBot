name: ğŸ” CodeQL Security Analysis

# Advanced security scanning with CodeQL
# Runs on schedule and PR for comprehensive coverage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly on Sundays at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ================================================================
  # ğŸ” CODEQL ANALYSIS - Deep security scanning
  # ================================================================
  codeql:
    name: ğŸ” CodeQL Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      actions: read
      contents: read
      security-events: write
    
    strategy:
      fail-fast: false
      matrix:
        language: [ 'python' ]
        # Add other languages if needed: 'javascript', 'java', 'csharp', etc.
    
    steps:
    - name: ğŸ“‚ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: codeql-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          codeql-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-
          
    - name: ğŸ”§ Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        # Custom queries for enhanced security
        queries: +security-and-quality
        config: |
          name: "DiceBot CodeQL Config"
          queries:
            - uses: security-and-quality
            - uses: security-extended
          paths-ignore:
            - "tests/**"
            - "docs/**"
            - "scripts/**"
            - "*.md"
            
    - name: ğŸ“¦ Install dependencies for analysis
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
        
    - name: ğŸ—ï¸ Autobuild
      uses: github/codeql-action/autobuild@v3
      
    - name: ğŸ” Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:${{matrix.language}}"
        upload: true
        
    - name: ğŸ“Š Upload SARIF results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: ../results/

  # ================================================================
  # ğŸ›¡ï¸ ADVANCED SECURITY SCAN - Multi-tool security analysis
  # ================================================================
  advanced-security:
    name: ğŸ›¡ï¸ Advanced Security
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      security-events: write
    
    steps:
    - name: ğŸ“‚ Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit[toml] safety semgrep
        
    - name: ğŸ”’ Bandit Security Scan
      run: |
        bandit -r src/ -f json -o bandit-results.json || true
        bandit -r src/ -f txt | tee bandit-results.txt || true
        
    - name: ğŸ›¡ï¸ Safety Vulnerability Check
      run: |
        safety check --json --output safety-results.json || true
        safety check | tee safety-results.txt || true
        
    - name: ğŸ” Semgrep Static Analysis
      run: |
        semgrep --config=auto --json --output=semgrep-results.json src/ || true
        semgrep --config=auto --text --output=semgrep-results.txt src/ || true
        
    - name: ğŸ”’ TruffleHog Secrets Scan
      run: |
        docker run --rm -v "$PWD:/pwd" \
          trufflesecurity/trufflehog:latest git file:///pwd \
          --json --no-verification > trufflehog-results.json || true
          
    - name: ğŸ“Š Security Report Summary
      run: |
        echo "# ğŸ”’ DiceBot Security Analysis Report" > security-summary.md
        echo "" >> security-summary.md
        echo "## ğŸ›¡ï¸ Scan Results" >> security-summary.md
        echo "" >> security-summary.md
        
        # Bandit results
        echo "### ğŸ”’ Bandit (Python Security)" >> security-summary.md
        if [ -f bandit-results.json ]; then
          BANDIT_ISSUES=$(jq '.results | length' bandit-results.json 2>/dev/null || echo "0")
          echo "- Issues found: $BANDIT_ISSUES" >> security-summary.md
        fi
        echo "" >> security-summary.md
        
        # Safety results
        echo "### ğŸ›¡ï¸ Safety (Dependency Vulnerabilities)" >> security-summary.md
        if [ -f safety-results.json ]; then
          SAFETY_VULNS=$(jq 'length' safety-results.json 2>/dev/null || echo "0")
          echo "- Vulnerabilities found: $SAFETY_VULNS" >> security-summary.md
        fi
        echo "" >> security-summary.md
        
        # Semgrep results
        echo "### ğŸ” Semgrep (Static Analysis)" >> security-summary.md
        if [ -f semgrep-results.json ]; then
          SEMGREP_FINDINGS=$(jq '.results | length' semgrep-results.json 2>/dev/null || echo "0")
          echo "- Findings: $SEMGREP_FINDINGS" >> security-summary.md
        fi
        echo "" >> security-summary.md
        
        # TruffleHog results
        echo "### ğŸ”’ TruffleHog (Secrets Detection)" >> security-summary.md
        if [ -f trufflehog-results.json ]; then
          SECRETS_FOUND=$(jq '. | length' trufflehog-results.json 2>/dev/null || echo "0")
          echo "- Potential secrets: $SECRETS_FOUND" >> security-summary.md
        fi
        
        echo "" >> security-summary.md
        echo "---" >> security-summary.md
        echo "*Generated on: $(date)*" >> security-summary.md
        
        cat security-summary.md
        
    - name: ğŸ“¤ Upload Security Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports-${{ github.run_number }}
        path: |
          *-results.json
          *-results.txt
          security-summary.md
        retention-days: 30
        
    - name: ğŸ“Š Create Security Issue (on failures)
      if: failure()
      run: |
        echo "Security scan detected issues - would create GitHub issue here"
        # Uncomment to auto-create issues:
        # gh issue create --title "ğŸ”’ Security Alert" --body "Security scan found issues in run ${{ github.run_number }}"

  # ================================================================
  # ğŸ” DEPENDENCY AUDIT - Supply chain security
  # ================================================================
  dependency-audit:
    name: ğŸ” Dependency Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“‚ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Install pip-audit
      run: |
        python -m pip install --upgrade pip
        pip install pip-audit
        
    - name: ğŸ” Audit Dependencies
      run: |
        pip-audit --format=json --output=pip-audit-results.json || true
        pip-audit --format=text | tee pip-audit-results.txt || true
        
    - name: ğŸ“Š Dependency Report
      run: |
        echo "# ğŸ” Dependency Security Audit" > dependency-report.md
        echo "" >> dependency-report.md
        
        if [ -f pip-audit-results.json ]; then
          VULNS=$(jq '.vulnerabilities | length' pip-audit-results.json 2>/dev/null || echo "0")
          echo "## Results: $VULNS vulnerabilities found" >> dependency-report.md
          echo "" >> dependency-report.md
          
          if [ "$VULNS" -gt "0" ]; then
            echo "### ğŸš¨ Vulnerabilities:" >> dependency-report.md
            jq -r '.vulnerabilities[] | "- **\(.package)** \(.installed_version): \(.vulnerability.summary)"' pip-audit-results.json >> dependency-report.md 2>/dev/null || true
          else
            echo "âœ… No vulnerabilities detected!" >> dependency-report.md
          fi
        fi
        
        echo "" >> dependency-report.md
        echo "*Scan completed: $(date)*" >> dependency-report.md
        
        cat dependency-report.md
        
    - name: ğŸ“¤ Upload Dependency Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dependency-audit-${{ github.run_number }}
        path: |
          pip-audit-results.*
          dependency-report.md
        retention-days: 30

  # ================================================================
  # ğŸ“¢ SECURITY NOTIFICATION - Alert on critical findings
  # ================================================================
  security-notify:
    name: ğŸ“¢ Security Notification
    runs-on: ubuntu-latest
    needs: [codeql, advanced-security, dependency-audit]
    if: always()
    
    steps:
    - name: ğŸ“Š Security Status
      run: |
        echo "ğŸ”’ Security Analysis Complete"
        echo "CodeQL: ${{ needs.codeql.result }}"
        echo "Advanced Security: ${{ needs.advanced-security.result }}"
        echo "Dependency Audit: ${{ needs.dependency-audit.result }}"
        
        if [[ "${{ needs.codeql.result }}" == "failure" || "${{ needs.advanced-security.result }}" == "failure" || "${{ needs.dependency-audit.result }}" == "failure" ]]; then
          echo "âš ï¸ Security issues detected - review required"
          exit 1
        else
          echo "âœ… All security checks passed"
        fi
