name: ğŸ”’ Weekly Security Assessment

on:
  schedule:
    # Every Monday at 6am UTC
    - cron: '0 6 * * 1'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true
    
jobs:
  comprehensive-security:
    name: ğŸ›¡ï¸ Comprehensive Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      security-events: write
    
    steps:
    - name: ğŸ“‚ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit[toml] safety semgrep
        pip install -e .
        
    - name: ğŸ” Advanced security linting
      run: |
        bandit -r src/ -f json -o bandit-detailed.json -v
        echo "âœ… Bandit scan completed"
        
    - name: ğŸ›¡ï¸ Dependency vulnerability assessment
      run: |
        safety check --json --output safety-detailed.json --full-report
        echo "âœ… Safety scan completed"
        
    - name: ğŸ”’ Secrets detection with trufflehog
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified
        
    - name: ğŸ“Š Semgrep security analysis
      run: |
        semgrep --config=auto --json --output=semgrep-report.json src/ || true
        echo "âœ… Semgrep scan completed"
        
    - name: ğŸ“‹ Upload comprehensive security reports
      uses: actions/upload-artifact@v4
      with:
        name: weekly-security-assessment-${{ github.run_number }}
        path: "*-report.json"
        retention-days: 90
        
    - name: ğŸ“¢ Security report notification
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        text: |
          ğŸ”’ **Weekly Security Assessment Complete**
          
          ğŸ“Š **Scans performed:**
          - ğŸ›¡ï¸ Bandit (code security)
          - ğŸ” Safety (dependencies)
          - ğŸ”’ TruffleHog (secrets)
          - ğŸ“ˆ Semgrep (advanced patterns)
          
          ğŸ“‹ **Reports:** Available in GitHub Actions artifacts
          ğŸ”— **Repository:** ${{ github.repository }}
          
          ğŸ¯ Security status: ${{ job.status }}
